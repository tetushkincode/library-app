<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Library Search</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #ffffff; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }

    th, td { 
      border: none;          /* remove borders */
      padding: 8px; 
      text-align: left; 
    }

    #booksTable tbody tr:nth-child(even) {
      background-color: #f2f2f2;  /* light grey */
    }
    
    #booksTable th {
      background: #e5e5e5;
      font-weight: bold;
    }
    
    input, select { margin-right: 10px; margin-bottom:15px; padding: 5px; }
    #booksTable td.action-col {
      white-space: nowrap;   /* prevents wrapping */
      width: 1%;             /* lets it shrink to fit */
    }
    
    #booksTable th.librarian-col,
    #booksTable td.librarian-col,
    
    #booksTable th.genre-col,
    #booksTable td.genre-col,
    
    #booksTable th.status-col,
    #booksTable td.status-col {
      display: none;
    }
    #booksTable td.genre-col {
      font-size: 10px;
    }

    /* Base button style */
    #booksTable td.action-col a {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 24px;
      color: white;
      text-decoration: none;
      font-size: 14px;
      font-weight: normal;
    }
    
    /* "Take book" button */
    #booksTable td.action-col a.take-book {
      background-color: #4A95D6;
    }
    
    /* "Take line" button */
    #booksTable td.action-col a.take-line {
      background-color: #707579;
    }

   .loading {
      animation: blink 2s infinite;
      color: grey;
      font-weight: bold;
    }
    
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.3; }
    }





    #filters {
      display: flex;
      flex-direction: column;   /* stack vertically */
      gap: 10px;                /* spacing between rows */
      max-width: 400px;         /* keeps it tidy on wide screens */
      margin-top: 35px;
      margin-bottom: 35px;
    }
    
    /* keep text and selects full width */
    #filters input[type="text"],
    #filters select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 16px;   /* better for tapping */
    }
    
    /* ‚úÖ fix checkbox + label inline */
    #filters label {
      display: flex;
      align-items: center;  /* keeps checkbox + text aligned */
      gap: 6px;             /* spacing between box and text */
      font-size: 15px;
      width: auto;          /* don‚Äôt stretch full width */
    }
    
    #filters input[type="checkbox"] {
      width: auto;          /* prevent checkbox from expanding */
      margin: 0;            /* reset margins */
    }





    
    @media (max-width: 600px) {
      /* Hide the table head completely */
      #booksTable thead {
        display: none !important;
      }
    
      /* Turn rows into cards */
      #booksTable,
      #booksTable tbody,
      #booksTable tr {
        display: block;
        width: 100%;
      }
    
      #booksTable tr {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background: #fafafa;
    
        /* ‚úÖ prevent overflow */
        box-sizing: border-box;
        overflow-wrap: break-word;
        word-break: break-word;
      }
    
      /* Each cell is a block, left-aligned */
      #booksTable td {
        display: block;
        text-align: left;
        padding: 6px 0;
      }
    
      /* Optional: remove label before text if you don‚Äôt want "Title:" showing */
      #booksTable td::before {
        display: none;
      }
    
      /* Buttons stay inline but won‚Äôt break layout */
      #booksTable td.action-col a {
        display: inline-block;     /* stay like buttons */
        margin-top: 6px;
        padding: 8px 14px;
        border-radius: 24px;
        text-decoration: none;
        color: #fff;
        white-space: nowrap;       /* keep text in one line */
        word-break: normal;        /* don‚Äôt break characters */
          }
        /* ensure action cell doesn't force overflow */
        #booksTable td.action-col {
          text-align: left;
        }
        /* ‚úÖ make sure table itself doesn‚Äôt push wider than screen */
        #booksTable {
        width: 100%;
        overflow-x: hidden;
      }
    }

  </style>


  
</head>
<body>
  <h2>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –î–∞–Ω–∞–Ω–≥–∞</h2>
  
  <div id="filters">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ –∂–∞–Ω—Ä—É">
    <select id="genreFilter">
      <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
    </select>
    <select id="librarianFilter">
      <option value="">–í—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–∏</option>
    </select>
    <label><input type="checkbox" id="availableOnly">–¢–æ–ª—å–∫–æ –¥–æ—Å—É—Ç–ø–Ω—ã–µ, –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏</label>
  </div>
    
  <h1 id="resultsCount">–ù–∞–π–¥–µ–Ω–æ ‚Äì 0 –∫–Ω–∏–≥</h1>


  <table id="booksTable">
    <thead>
      <tr>
        <th class="title-col">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th class="author-col">–ê–≤—Ç–æ—Ä</th>
        <th class="action-col"></th>
        <th class="genre-col">–ñ–∞–Ω—Ä</th>
        <th class="librarian-col">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å</th>
        <th class="status-col">–°—Ç–∞—Ç—É—Å</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const publicSpreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsbONmnLPfGlepVvJkasahs9_BQaYspP4rK15IFRhRqXkcPGTdWsog5XoxL0T0Eid5GL3VU2I3otzD/pub?gid=0&single=true&output=csv";
    let books = [];
    
    function renderTable(data) {
      const tbody = document.querySelector("#booksTable tbody");
      tbody.innerHTML = "";
    
      data.forEach(book => {
        const row = document.createElement("tr");
    
        // Title
        const titleCell = document.createElement("td");
        titleCell.textContent = book["Title"] || "";
        titleCell.classList.add("title-col");
        titleCell.setAttribute("data-label", "Title");
        row.appendChild(titleCell);
    
        // Author
        const authorCell = document.createElement("td");
        authorCell.textContent = book["Author"] || "";
        authorCell.classList.add("author-col");
        authorCell.setAttribute("data-label", "Author");
        row.appendChild(authorCell);
      
        // Action link logic
        const actionCell = document.createElement("td");
        actionCell.classList.add("action-col"); 
        actionCell.setAttribute("data-label", "Action");
        if (book["Current Status"] === "Available") {
          const link = document.createElement("a");
          link.href = `https://t.me/biblioteka_danang_bot?start=request_borrow_${book["Book ID"]}`;
          link.textContent = "–í–∑—è—Ç—å –∫–Ω–∏–≥—É";
          link.target = "_blank";
          link.classList.add("take-book");   // üîπ add class
          actionCell.classList.add("action-col"); // mark cell as action column
          actionCell.appendChild(link);
        } else if (book["Current Status"] === "Borrowed") {
          const link = document.createElement("a");
          link.href = `https://t.me/biblioteka_danang_bot?start=wlist_${book["Book ID"]}`;
          link.textContent = "–ó–∞–Ω—è—Ç—å –æ—á–µ—Ä–µ–¥—å";
          link.target = "_blank";
          link.classList.add("take-line");   // üîπ add class
          actionCell.appendChild(link);
        } else {
          actionCell.textContent = "-";
        }
        row.appendChild(actionCell);
        
        // Genre
        const genreCell = document.createElement("td");
        genreCell.textContent = book["Genre"] || "";
        genreCell.classList.add("genre-col");     // üëà add class
        row.appendChild(genreCell);

        // Librarian
        const librarianCell = document.createElement("td");
        librarianCell.textContent = book["Responsible Librarian Username"] || "";
        librarianCell.classList.add("librarian-col");
        row.appendChild(librarianCell);

        // Status
        const statusCell = document.createElement("td");
        statusCell.textContent = book["Current Status"] || "";
        statusCell.classList.add("status-col");   // üëà add class
        row.appendChild(statusCell);
        
        tbody.appendChild(row);
      });

      document.getElementById("resultsCount").textContent = `–ù–∞–π–¥–µ–Ω–æ ‚Äì ${data.length} –∫–Ω–∏–≥`;

    }



    function filterBooks() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const genre = document.getElementById("genreFilter").value;
      const availableOnly = document.getElementById("availableOnly").checked;
      const librarian = document.getElementById("librarianFilter").value;
      
      const filtered = books.filter(b => {
        const matchSearch =
          b.Title.toLowerCase().includes(query) ||
          b.Author.toLowerCase().includes(query) ||
          b.Genre.toLowerCase().includes(query);
      
        const matchGenre = genre ? b.Genre.toLowerCase().includes(genre.toLowerCase()) : true;
        const matchAvailable = availableOnly ? b["Current Status"].toLowerCase() === "available" : true;
        const matchLibrarian = librarian ? b["Responsible Librarian Username"] === librarian : true;
      
        return matchSearch && matchGenre && matchAvailable && matchLibrarian;
      });


      renderTable(filtered);
    }

    document.getElementById("resultsCount").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥...";
    document.getElementById("resultsCount").classList.add("loading");  
    
    // Load CSV
    Papa.parse(publicSpreadsheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        books = results.data.filter(row => row.Title); // remove empty rows
        renderTable(books);
        
    document.getElementById("resultsCount").classList.remove("loading");
    document.getElementById("resultsCount").textContent = `–ù–∞–π–¥–µ–Ω–æ ‚Äì ${books.length} –∫–Ω–∏–≥`;


        // fill dropdown with unique genres
        const genres = [...new Set(books.flatMap(b => b.Genre.split(",").map(g => g.trim())))];
        const genreFilter = document.getElementById("genreFilter");
        genres.sort().forEach(g => {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          genreFilter.appendChild(opt);
        });
        
        // mapping librarian usernames -> names
        const librarianMap = {
          "alisss_kaa": "Alisa",
          "it1st1m3": "Sonya",
          "nganigga": "Nikita",
          "illeeeya": "Inna",
          "tetushkin": "Oleg"
          // add others...
        };
        
        // fill librarians dropdown with unique librarians
        const librarians = [...new Set(books.map(b => b["Responsible Librarian Username"]).filter(Boolean))];
        const librarianFilter = document.getElementById("librarianFilter");
        
        // reset dropdown
        librarianFilter.innerHTML = '<option value="">–í—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–∏</option>';
        
        librarians.sort().forEach(username => {
          const opt = document.createElement("option");
          opt.value = username; // still filter by username internally
          opt.textContent = librarianMap[username] || username; // show name instead
          librarianFilter.appendChild(opt);
        });


        
      }
    });

    document.getElementById("searchInput").addEventListener("input", filterBooks);
    document.getElementById("genreFilter").addEventListener("change", filterBooks);
    document.getElementById("availableOnly").addEventListener("change", filterBooks);
    document.getElementById("librarianFilter").addEventListener("change", filterBooks);

  </script>
</body>
</html>
