<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Library Search</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    input, select { margin-right: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h2>ðŸ“š My Library</h2>

  <input type="text" id="searchInput" placeholder="Search by title, author, or genre">
  <select id="genreFilter">
    <option value="">All Genres</option>
  </select>
  <label><input type="checkbox" id="availableOnly"> Available only</label>

  <table id="booksTable">
    <thead>
      <tr>
        <th>Title</th><th>Author</th><th>Status</th><th>Genre</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const publicSpreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQqir_B-_AnqRrFHeRkFHRETbe76WvGeF5nXcacHMNVAOtUHORA77jrULyNei6OFuJBylXXWzUL1JG/pub?output=csv";
    let books = [];

    function renderTable(data) {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = "";
    
      data.forEach(book => {
        const row = document.createElement("tr");
    
        row.innerHTML = `
          <td>${book["Title"] || ""}</td>
          <td>${book["Author"] || ""}</td>
          <td>${book["Genre"] || ""}</td>
          <td>${book["Current Status"] || ""}</td>
          <td>
            ${book["Current Status"] === "Available" 
              ? `<a href="https://t.me/biblioteka_danang_bot?start=request_borrow_${book['Book ID']}" target="_blank">Take book</a>` 
              : `<a href="https://t.me/biblioteka_danang_bot?start=wlist_${book['Book ID']}" target="_blank">Take line</a>`}
          </td>
        `;
    
        tbody.appendChild(row);
      });
    }


    function filterBooks() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const genre = document.getElementById("genreFilter").value;
      const availableOnly = document.getElementById("availableOnly").checked;

      const filtered = books.filter(b => {
        const matchSearch =
          b.Title.toLowerCase().includes(query) ||
          b.Author.toLowerCase().includes(query) ||
          b.Genre.toLowerCase().includes(query);

        const matchGenre = genre ? b.Genre.toLowerCase().includes(genre.toLowerCase()) : true;
        const matchAvailable = availableOnly ? b["Current Status"].toLowerCase() === "available" : true;

        return matchSearch && matchGenre && matchAvailable;
      });

      renderTable(filtered);
    }

    // Load CSV
    Papa.parse(publicSpreadsheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        books = results.data.filter(row => row.Title); // remove empty rows
        renderTable(books);

        // fill dropdown with unique genres
        const genres = [...new Set(books.flatMap(b => b.Genre.split(",").map(g => g.trim())))];
        const genreFilter = document.getElementById("genreFilter");
        genres.sort().forEach(g => {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          genreFilter.appendChild(opt);
        });
      }
    });

    document.getElementById("searchInput").addEventListener("input", filterBooks);
    document.getElementById("genreFilter").addEventListener("change", filterBooks);
    document.getElementById("availableOnly").addEventListener("change", filterBooks);
  </script>
</body>
</html>
